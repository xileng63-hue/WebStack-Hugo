<!-- ======================================================= -->
<!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸç‰ˆåŠŸèƒ½åŒº (ä¿ç•™æ‰€æœ‰æŒ‰é’®) -->
<!-- ======================================================= -->
<footer class="main-footer footer-type-1 text-xs">
    <div id="footer-tools" class="d-flex flex-column">
        <!-- 1. å›åˆ°é¡¶éƒ¨ -->
        <a href="javascript:" id="go-to-up" class="btn rounded-circle go-up m-1" rel="go-top">
            <i class="iconfont icon-to-up"></i>
        </a>
        
        <!-- 2. æœç´¢ -->
        <a href="javascript:" data-toggle="modal" data-target="#search-modal" class="btn rounded-circle m-1" rel="search" one-link-mark="yes">
            <i class="iconfont icon-search"></i>
        </a>
        
        <!-- 3. å®¢æœ -->
        <a href="https://github.com/shenweiyan/WebStack-Hugo" class="btn rounded-circle kefu m-1" target="_blank" data-toggle="tooltip" data-placement="left" title="è”ç³»æˆ‘ä»¬">
            <i class="mode-ico iconfont icon-qq"></i>
        </a>
        
        <!-- 4. å¤œé—´æ¨¡å¼åˆ‡æ¢ (éƒ¨ç½²åæ˜¾ç¤º) -->
        {{ if $.Site.Params.nightMode }}
        <a href="javascript:" onclick="window.location.href='javascript:switchNightMode()'" class="btn rounded-circle switch-dark-mode m-1" id="yejian"
            data-toggle="tooltip" data-placement="left" title="å¤œé—´æ¨¡å¼">
            <i class="mode-ico iconfont icon-light"></i>
        </a>
        {{ else }}
        <a href="javascript:" onclick="window.location.href='javascript:switchNightMode()'" class="btn rounded-circle switch-dark-mode m-1" id="yejian"
            data-toggle="tooltip" data-placement="left" title="æ—¥é—´æ¨¡å¼">
            <i class="mode-ico iconfont icon-night"></i>
        </a>
        {{ end }}
    </div>

    <!-- 5. ç‰ˆæƒ -->
    <div class="footer-inner">
        <div class="footer-text">
            &copy; 2025 <strong>æˆ‘çš„ä¸“å±å¯¼èˆªç«™</strong> | 
            <a href="https://github.com/WebStackPage/WebStack-Hugo" target="_blank">WebStack-Hugo</a>
        </div>
    </div>
</footer>

<!-- ======================================================= -->
<!-- ç¬¬äºŒéƒ¨åˆ†ï¼šå…¨èƒ½æ‚¬æµ®æ¨¡æ¿ (å°†è¢«è„šæœ¬å…‹éš†åˆ° Body) -->
<!-- ======================================================= -->
<div id="floating-template" style="display: none;">
    
    <!-- A. æ——èˆ°ç‰ˆå¤©æ°”èƒ¶å›Š (é¡¶éƒ¨) -->
    <div id="info-capsule-body" style="
        position: fixed; 
        top: 20px; 
        left: 50%; 
        transform: translateX(-50%); 
        z-index: 2147483647;
        
        /* ç£¨ç ‚ç»ç’ƒ */
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.6);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        border-radius: 24px;
        
        /* å¸ƒå±€ */
        padding: 6px 20px;
        display: flex;
        align-items: center; 
        justify-content: center;
        gap: 15px;
        font-family: -apple-system, sans-serif;
        color: #333;
        white-space: nowrap;
        pointer-events: auto;
        visibility: hidden; /* åˆå§‹éšè—ï¼Œè„šæœ¬æ§åˆ¶æ˜¾ç¤º */
        opacity: 0;
        transition: all 0.5s ease;
    ">
       <!-- æ—¶é—´ -->
       <div class="time-group" style="display: flex; flex-direction: column; align-items: center; text-align: center; min-width: 80px;">
           <div id="time-text" style="font-size: 24px; font-weight: 600; line-height: 1; color: #1d1d1f; letter-spacing: 0.5px; font-variant-numeric: tabular-nums;">00:00</div>
           <div style="font-size: 10px; color: #666; margin-top: 4px; font-weight: 500;">
               <span id="date-text">...</span> <span style="opacity: 0.4; margin: 0 2px;">|</span> <span id="lunar-text">...</span>
           </div>
       </div>
       <div style="width: 1px; height: 30px; background: rgba(0,0,0,0.15);"></div>
       <!-- å¤©æ°” Iframe -->
       <div style="display: flex; align-items: center; justify-content: center; height: 40px;">
           <iframe scrolling="no" src="https://i.tianqi.com/index.php?c=code&id=10&color=%23333&icon=1&site=12" frameborder="0" width="260" height="25" allowtransparency="true"></iframe>
       </div>
    </div>

    <!-- B. Gemini AI è§¦å‘çƒ (å³ä¸‹è§’) -->
    <div id="gemini-trigger" onclick="toggleGeminiChat()" style="
        position: fixed; 
        bottom: 100px; 
        right: 20px; 
        z-index: 2147483647; 
        width: 48px; 
        height: 48px; 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        border-radius: 50%; 
        box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4); 
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        transition: transform 0.3s ease;
        visibility: hidden;
        opacity: 0;
    ">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M12 2L14.4 9.6L22 12L14.4 14.4L12 22L9.6 14.4L2 12L9.6 9.6L12 2Z" fill="white"/></svg>
    </div>

    <!-- C. èŠå¤©çª—å£ -->
    <div id="gemini-chat-window" style="
        display: none; 
        position: fixed; bottom: 160px; right: 20px; 
        width: 340px; height: 480px; 
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 18px; 
        box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
        z-index: 2147483647; 
        flex-direction: column; 
        overflow: hidden;
        font-family: -apple-system, sans-serif;
    ">
        <div style="background: rgba(248, 249, 250, 0.8); padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight: 600; color: #333;">âœ¨ Gemini AI</span>
            <span onclick="toggleGeminiChat()" style="cursor: pointer; color: #999; font-size: 20px;">&times;</span>
        </div>
        <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; font-size: 13px; line-height: 1.6;">
            <div style="margin-bottom: 12px; color: #666; background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px;">ğŸ‘‹ æœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®ä½ çš„å—ï¼Ÿ</div>
        </div>
        <div style="padding: 12px; border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 8px;">
            <input type="text" id="user-input" placeholder="è¾“å…¥é—®é¢˜..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px;" onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()" style="background: #764ba2; color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer;">â¤</button>
        </div>
    </div>
</div>

<!-- ======================================================= -->
<!-- æ™ºèƒ½è„šæœ¬ (è´Ÿè´£å…‹éš†ä¸é€»è¾‘) -->
<!-- ======================================================= -->
<script>
    (function() {
        // âš ï¸ è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ çš„ API Key âš ï¸
        const GEMINI_API_KEY = 'AIzaSyCJogRHhJ8ib96V01JpZW-upOnhdrv3NAU'; 

        // ä¸»åˆå§‹åŒ–å‡½æ•°
        function initApp() {
            // 1. é˜²æ­¢é‡å¤åˆå§‹åŒ–
            if (document.getElementById('floating-components-active')) return;

            // 2. è·å–æ¨¡æ¿
            const template = document.getElementById('floating-template');
            if (!template) return;

            // 3. åˆ›å»ºä¸€ä¸ªå®¹å™¨å¹¶å…‹éš†å†…å®¹
            const activeContainer = document.createElement('div');
            activeContainer.id = 'floating-components-active';
            activeContainer.innerHTML = template.innerHTML;
            document.body.appendChild(activeContainer);

            // 4. æ¸…ç†æ¨¡æ¿ (å¯é€‰)
            template.remove();

            // 5. æ˜¾å½¢ (å»¶è¿Ÿä¸€ç‚¹ç‚¹ç¡®ä¿æ¸²æŸ“)
            setTimeout(() => {
                const capsule = activeContainer.querySelector('#info-capsule-body');
                const trigger = activeContainer.querySelector('#gemini-trigger');
                if(capsule) { capsule.style.visibility = 'visible'; capsule.style.opacity = '1'; }
                if(trigger) { trigger.style.visibility = 'visible'; trigger.style.opacity = '1'; }
            }, 100);

            // 6. ç»‘å®šé€»è¾‘ (å¿…é¡»åœ¨å…‹éš†åç»‘å®šï¼Œå› ä¸ºå…ƒç´ æ˜¯æ–°çš„)
            bindLogic(activeContainer);
        }

        function bindLogic(container) {
            // --- æ—¶é’Ÿé€»è¾‘ ---
            const timeText = container.querySelector('#time-text');
            const dateText = container.querySelector('#date-text');
            const lunarText = container.querySelector('#lunar-text');

            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                if(timeText) timeText.innerText = `${hours}:${minutes}`;

                const months = now.getMonth() + 1;
                const days = now.getDate();
                const weekArr = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
                const week = weekArr[now.getDay()];
                if(dateText) dateText.innerText = `${months}æœˆ${days}æ—¥ ${week}`;

                try {
                    const lunarDate = new Intl.DateTimeFormat('zh-CN-u-ca-chinese', { day: 'numeric', month: 'numeric' }).format(now);
                    const cleanLunar = lunarDate.split(' ').pop().replace('æœˆ', '/');
                    if(lunarText) lunarText.innerText = `å†œå†${cleanLunar}`;
                } catch (e) {}
            }
            updateClock();
            setInterval(updateClock, 1000);

            // --- äº¤äº’ç‰¹æ•ˆ ---
            const capsule = container.querySelector('#info-capsule-body');
            if(capsule) {
                capsule.addEventListener('mouseenter', () => { capsule.style.transform = 'translateX(-50%) scale(1.02)'; capsule.style.background = 'rgba(255,255,255,0.95)'; });
                capsule.addEventListener('mouseleave', () => { capsule.style.transform = 'translateX(-50%) scale(1)'; capsule.style.background = 'rgba(255,255,255,0.85)'; });
            }
        }

        // --- å…¨å±€æš´éœ²ç»™ HTML onclick ä½¿ç”¨çš„å‡½æ•° ---
        window.toggleGeminiChat = function() {
            const container = document.getElementById('floating-components-active');
            if(!container) return;
            const chatWindow = container.querySelector('#gemini-chat-window');
            const input = container.querySelector('#user-input');
            
            if (chatWindow.style.display === 'none') {
                chatWindow.style.display = 'flex';
                chatWindow.style.opacity = '0';
                chatWindow.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    chatWindow.style.opacity = '1';
                    chatWindow.style.transform = 'translateY(0)';
                }, 10);
                if(input) input.focus();
            } else {
                chatWindow.style.display = 'none';
            }
        }

        window.handleKeyPress = function(e) {
            if (e.key === 'Enter') window.sendMessage();
        }

        window.sendMessage = async function() {
            const container = document.getElementById('floating-components-active');
            const inputField = container.querySelector('#user-input');
            const messagesDiv = container.querySelector('#chat-messages');
            const text = inputField.value.trim();
            if (!text) return;
            
            if (!GEMINI_API_KEY) {
                appendMessage(messagesDiv, "âš ï¸ è¯·å…ˆåœ¨ä»£ç ä¸­é…ç½® API Key", 'ai');
                return;
            }

            inputField.value = '';
            appendMessage(messagesDiv, text, 'user');
            
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.style.marginBottom = '10px';
            loadingDiv.style.color = '#999';
            loadingDiv.style.fontSize = '12px';
            loadingDiv.innerHTML = 'âœ¨ æ€è€ƒä¸­...';
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
                });

                const data = await response.json();
                document.getElementById(loadingId)?.remove();

                if (data.error) {
                    appendMessage(messagesDiv, "Error: " + data.error.message, 'ai');
                } else {
                    const aiResponse = data.candidates[0].content.parts[0].text;
                    appendMessage(messagesDiv, aiResponse, 'ai');
                }
            } catch (error) {
                document.getElementById(loadingId)?.remove();
                appendMessage(messagesDiv, "ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚", 'ai');
            }
        }

        function appendMessage(container, text, sender) {
            if(!container) return;
            const div = document.createElement('div');
            div.style.marginBottom = '12px';
            div.style.padding = '8px 12px';
            div.style.borderRadius = '12px';
            div.style.maxWidth = '85%';
            div.style.lineHeight = '1.5';
            div.style.wordWrap = 'break-word';
            
            if (sender === 'user') {
                div.style.background = '#764ba2'; 
                div.style.color = 'white';
                div.style.marginLeft = 'auto'; 
                div.style.borderBottomRightRadius = '2px';
            } else {
                div.style.background = 'rgba(0,0,0,0.05)'; 
                div.style.color = '#333';
                div.style.marginRight = 'auto'; 
                div.style.borderBottomLeftRadius = '2px';
            }
            div.innerHTML = text.replace(/\n/g, '<br>');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // å¯åŠ¨é€»è¾‘ (ç¡®ä¿ DOM Ready)
        if (document.readyState === 'loading') {
            window.addEventListener('load', initApp);
        } else {
            initApp();
        }
    })();
</script>
