<footer class="main-footer footer-type-1 text-xs">
    <!-- è¿™é‡Œçš„ div åªæ˜¯å ä½ -->
    <div id="footer-tools" class="d-flex flex-column">
        <div class="footer-text text-center">
            <p style="margin: 0;">&copy; 2025 <strong>æˆ‘çš„ä¸“å±å¯¼èˆªç«™</strong></p>
        </div>
    </div>
</footer>

<!-- ======================================================= -->
<!-- æ——èˆ°ç‰ˆä¿¡æ¯èƒ¶å›Š (è‡ªåŠ¨æ¬è¿åˆ° Body) -->
<!-- ======================================================= -->
<!-- æ³¨æ„ï¼šå»æ‰äº† display: noneï¼Œæ”¹ä¸º visibility: hiddenï¼Œé˜²æ­¢è„šæœ¬å¤±æ•ˆæ—¶å½»åº•æ¶ˆå¤± -->
<div id="info-capsule-template" style="
    visibility: hidden; 
    opacity: 0;
    position: fixed; 
    top: 20px; 
    left: 50%; 
    transform: translateX(-50%); 
    z-index: 2147483647; 
    
    /* --- æ——èˆ°çº§ç£¨ç ‚ç»ç’ƒç‰¹æ•ˆ --- */
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px) saturate(180%);
    -webkit-backdrop-filter: blur(20px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.6);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    border-radius: 24px;
    
    /* --- å¸ƒå±€è®¾ç½® --- */
    padding: 8px 24px;
    align-items: center; 
    justify-content: center;
    gap: 20px;
    
    /* å­—ä½“è®¾ç½® */
    font-family: -apple-system, 'PingFang SC', 'Microsoft YaHei', sans-serif;
    color: #333;
    white-space: nowrap;
    
    /* æ ·å¼é‡ç½® */
    box-sizing: border-box;
    line-height: normal;
    text-align: left;
    pointer-events: auto;
    
    transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
">

   <!-- å·¦ä¾§ï¼šæ—¶é—´ä¸æ—¥æœŸ -->
   <div class="time-group" style="display: flex; flex-direction: column; align-items: center; text-align: center; min-width: 90px;">
       <div id="time-text" style="font-size: 26px; font-weight: 600; line-height: 1; color: #1d1d1f; letter-spacing: 0.5px; font-variant-numeric: tabular-nums;">
           00:00
       </div>
       <div style="font-size: 11px; color: #666; margin-top: 5px; font-weight: 500;">
           <span id="date-text">...</span> <span style="opacity: 0.4; margin: 0 3px;">|</span> <span id="lunar-text">...</span>
       </div>
   </div>
   
   <!-- åˆ†éš”çº¿ -->
   <div class="divider" style="width: 1px; height: 32px; background: rgba(0,0,0,0.15);"></div>

   <!-- å³ä¾§ï¼šæ™ºèƒ½å¤©æ°”è½®æ’­ -->
   <div id="weather-box" style="
       display: flex; 
       align-items: center; 
       justify-content: center;
       min-width: 120px;
       height: 46px;
       opacity: 1;
       transition: opacity 0.3s ease;
       text-align: center;
   ">
       <span style="font-size: 12px; color: #888;">æ­£åœ¨å®šä½...</span>
   </div>

</div>

<!-- æ™ºèƒ½è„šæœ¬ -->
<script>
    (function() {
        // --- åˆå§‹åŒ–å‡½æ•° ---
        function initCapsule() {
            // 1. æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ï¼ˆé˜²æ­¢ PJAX é‡å¤åŠ è½½ï¼‰
            if (document.getElementById('info-capsule-active')) return;

            // 2. è·å–æ¨¡æ¿
            var template = document.getElementById('info-capsule-template');
            if (!template) return;

            // 3. å…‹éš†å¹¶æ¬è¿åˆ° Body
            var capsule = template.cloneNode(true);
            capsule.id = 'info-capsule-active'; // æ¿€æ´»çš„æ–°ID
            capsule.style.display = 'flex'; // ç¡®ä¿å¸ƒå±€ä¸º flex
            document.body.appendChild(capsule);

            // 4. æ˜¾å½¢åŠ¨ç”» (ç¨å¾®å»¶è¿Ÿä¸€ç‚¹ç‚¹ï¼Œç¡®ä¿æ¬è¿å®Œæˆ)
            setTimeout(function() {
                capsule.style.visibility = 'visible';
                capsule.style.opacity = '1';
                capsule.style.top = '20px'; // ç¡®ä¿ä½ç½®æ­£ç¡®
            }, 100);

            // 5. å¯åŠ¨é€»è¾‘
            startLogic(capsule);
            
            // 6. æ¸…ç†æ¨¡æ¿ï¼ˆå¯é€‰ï¼Œä¿æŒ DOM å¹²å‡€ï¼‰
            template.remove();
        }

        // --- ä¸šåŠ¡é€»è¾‘ ---
        function startLogic(container) {
            const CAROUSEL_INTERVAL = 8000; 
            let weatherData = null;
            let currentSlideIndex = 0; 
            let weatherInterval = null;

            // è·å–å…ƒç´ å¼•ç”¨ï¼ˆåœ¨æ–°çš„å®¹å™¨å†…æŸ¥æ‰¾ï¼‰
            const timeText = container.querySelector('#time-text');
            const dateText = container.querySelector('#date-text');
            const lunarText = container.querySelector('#lunar-text');
            const weatherBox = container.querySelector('#weather-box');

            function getWeatherIcon(code) {
                if (code === 0) return 'â˜€ï¸';
                if (code >= 1 && code <= 3) return 'â›…';
                if (code >= 45 && code <= 48) return 'ğŸŒ«ï¸';
                if (code >= 51 && code <= 67) return 'ğŸŒ§ï¸';
                if (code >= 71 && code <= 77) return 'â„ï¸';
                if (code >= 80 && code <= 82) return 'ğŸŒ¦ï¸';
                if (code >= 95 && code <= 99) return 'â›ˆï¸';
                return 'ğŸŒ¡ï¸';
            }

            async function initWeather() {
                let latitude = 39.9042;
                let longitude = 116.4074;
                let city = "æœ¬åœ°";

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    const geoRes = await fetch('https://get.geojs.io/v1/ip/geo.json', { signal: controller.signal });
                    const geoData = await geoRes.json();
                    
                    if (geoData.latitude && geoData.longitude) {
                        latitude = geoData.latitude;
                        longitude = geoData.longitude;
                        city = geoData.city || geoData.region || "æœ¬åœ°";
                    }
                    clearTimeout(timeoutId);
                } catch (e) { console.warn("å®šä½è¶…æ—¶"); }

                try {
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=auto&forecast_days=3`);
                    const wData = await weatherRes.json();
                    weatherData = { city: city, current: wData.current_weather, daily: wData.daily };
                    
                    renderWeather();
                    if (weatherInterval) clearInterval(weatherInterval);
                    weatherInterval = setInterval(renderWeather, CAROUSEL_INTERVAL);
                } catch (e) {
                    if(weatherBox) weatherBox.innerHTML = '<span style="font-size:12px;color:#999;">å¤©æ°”æœåŠ¡ç»´æŠ¤ä¸­</span>';
                }
            }

            function renderWeather() {
                if (!weatherData || !weatherData.daily) return;
                
                weatherBox.style.opacity = '0';
                
                setTimeout(() => {
                    let htmlContent = '';
                    if (currentSlideIndex === 0) {
                        const temp = Math.round(weatherData.current.temperature);
                        const icon = getWeatherIcon(weatherData.current.weathercode);
                        htmlContent = `
                            <div style="display:flex; flex-direction:column; align-items:center;">
                                <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 3px;">
                                    ${icon} ${temp}Â°C
                                </div>
                                <div style="font-size: 11px; color: #666;">
                                    ğŸ“ ${weatherData.city} Â· å®æ—¶
                                </div>
                            </div>`;
                        currentSlideIndex = 1; 
                    } else {
                        const dayIndex = currentSlideIndex;
                        if (weatherData.daily.time[dayIndex]) {
                            const max = Math.round(weatherData.daily.temperature_2m_max[dayIndex]);
                            const min = Math.round(weatherData.daily.temperature_2m_min[dayIndex]);
                            const icon = getWeatherIcon(weatherData.daily.weathercode[dayIndex]);
                            const dayName = (dayIndex === 1) ? "æ˜å¤©" : "åå¤©";
                            htmlContent = `
                                <div style="display:flex; flex-direction:column; align-items:center;">
                                    <div style="font-size: 15px; font-weight: 600; color: #555; margin-bottom: 3px;">
                                        ${dayName} ${icon}
                                    </div>
                                    <div style="font-size: 11px; color: #666;">
                                        ${min}Â° ~ ${max}Â°
                                    </div>
                                </div>`;
                        }
                        currentSlideIndex++;
                        if (currentSlideIndex > 2) currentSlideIndex = 0; 
                    }
                    weatherBox.innerHTML = htmlContent;
                    weatherBox.style.opacity = '1'; 
                }, 300);
            }

            function updateClock() {
                const now = new Date();
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                if(timeText) timeText.innerText = `${hours}:${minutes}`;

                const months = now.getMonth() + 1;
                const days = now.getDate();
                const weekArr = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
                const week = weekArr[now.getDay()];
                if(dateText) dateText.innerText = `${months}æœˆ${days}æ—¥ ${week}`;

                try {
                    const lunarDate = new Intl.DateTimeFormat('zh-CN-u-ca-chinese', { day: 'numeric', month: 'numeric' }).format(now);
                    const cleanLunar = lunarDate.split(' ').pop().replace('æœˆ', '/');
                    if(lunarText) lunarText.innerText = `å†œå†${cleanLunar}`;
                } catch (e) {}
            }

            initWeather();
            updateClock();
            setInterval(updateClock, 1000);
            
            // äº¤äº’ç‰¹æ•ˆ
            container.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(255, 255, 255, 0.95)';
                this.style.transform = 'translateX(-50%) scale(1.02)';
            });
            container.addEventListener('mouseleave', function() {
                this.style.background = 'rgba(255, 255, 255, 0.85)';
                this.style.transform = 'translateX(-50%) scale(1)';
            });
        }

        // --- ç¡®ä¿é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ ---
        if (document.readyState === 'loading') {
            window.addEventListener('load', initCapsule);
        } else {
            initCapsule();
        }
    })();
</script>
